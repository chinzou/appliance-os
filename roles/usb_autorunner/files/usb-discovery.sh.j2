#!/bin/bash

filteredDeviceLabel=("cluster-nfs-disk")
mkdir -p /mnt/usb

inotifywait --format '%f' -m /dev -e CREATE | while read device
do
	devIsConnected=$(blkid -o device | grep "dev/sd")

	if [[ ( "$devIsConnected" != 0) ]]
	then
		echo "device connected"
		echo $device
		if [[ $device =~ ^sd.* ]]
		then

			mkdir -p /mnt/usb/$device
			echo "Reading device..."
			mount /dev/$device /mnt/usb/$device 
			echo $(lsblk /dev/$device -o MOUNTPOINT -n)
			if [[ ! $(lsblk /dev/$device -o LABEL -n) =~ $filteredDeviceLabel ]]
			then
				{{ usb_autorunner_install_path }}/autorunner.sh $(lsblk /dev/$device -o MOUNTPOINT -n) 
			fi
			echo "done."
		fi
	fi
done
